#include "spi.h"

/*????????????? SPI*/
void SPI_Init(void)
{
  /*????????? ?????? ?????-??????
  ??? ??????, ????? MISO ??????*/
    SPI_DDR&= ~(1 << CS_PIN)&~(1<<SDO_PIN)&~(1<<SCK_PIN);
    SPI_DDR|= (1 << SDI_PIN);
    SPI_PORT|= (1 << CS_PIN);
    SSPCONbits.SSPEN= 1;
    SSPCONbits.SSPM0= 1;
    SSPSTATbits.SMP= 1;
    SSPSTATbits.CKE= 0;
}

void chipSelect(){
    SPI_PORT &= ~(1<<CS_PIN);
}

void chipRelease(){
    SPI_PORT |= (1<<CS_PIN);
}

/*???????? ???? ?????? ?? SPI*/
void SPI_WriteByte(uint8_t data)
{
   chipSelect();
   SSPBUF = data;
   while(!BF);
   chipRelease();
}


/*???????? ? ???????? ???? ?????? ?? SPI*/
uint8_t SPI_ReadByte(uint8_t data)
{
   uint8_t report;

   chipSelect();
   SSPBUF = data;
   while(!SSPSTATbits.BF);
   report = SSPBUF;
   chipRelease();

   return report;
}

/*????????? ????????? ???? ?????? ?? SPI*/
void SPI_WriteArray(uint8_t num, uint8_t *data)
{
   chipSelect();
   while(num--){
      SSPBUF = *data++;
      while(!SSPSTATbits.BF);
   }
   chipRelease();
}

/*????????? ? ???????? ????????? ???? ?????? ?? SPI*/
void SPI_ReadArray(uint8_t num, uint8_t *data)
{
   chipSelect();
   while(num--){
      SSPBUF = *data;
      while(!SSPSTATbits.BF);
      *data++ = SSPBUF;
   }
   chipRelease();
}